!function(e,t){"use strict";if("function"==typeof define&&define.amd)define([],t);else{var n=t.call(e);Object.keys(n).forEach(function(t){e[t]=n[t]})}}(this,function(){"use strict";function e(e){G.console&&(G.console.error?G.console.error(e):G.console.log&&G.console.log(e))}function t(e){return e=e||G,e!=e.top}function n(e){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>"}function r(e,t){function r(t){var r=e.parentNode;r&&(r.innerHTML=n(t))}if(!G.WebGLRenderingContext)return r(k),null;var i=W(e,t);return i||r(X),i}function i(){t()&&(document.body.className="iframe")}function o(e,n,o){var a=o||{};if(t()){if(i(),!a.dontResize&&a.resize!==!1){var u=e.clientWidth,l=e.clientHeight;e.width=u,e.height=l}}else if(!a.noTitle&&a.title!==!1){var f=document.title,s=document.createElement("h1");s.innerText=f,document.body.insertBefore(s,document.body.children[0])}var g=r(e,n);return g}function a(t,n,r,i){var o=i||e,a=t.createShader(r);t.shaderSource(a,n),t.compileShader(a);var u=t.getShaderParameter(a,t.COMPILE_STATUS);if(!u){var l=t.getShaderInfoLog(a);return o("*** Error compiling shader of type '"+r+"' source:"+n+"':"+l),t.deleteShader(a),null}return a}function u(t,n,r,i,o){for(var a=o||e,u=t.createProgram(),l=0;l<n.length;++l)t.attachShader(u,n[l]);if(r)for(var l=0;l<r.length;++l)t.bindAttribLocation(u,i?i[l]:l,r[l]);t.linkProgram(u);var f=t.getProgramParameter(u,t.LINK_STATUS);if(!f){var s=t.getProgramInfoLog(u);return a("Error in program linking:"+s),t.deleteProgram(u),null}return u}function l(e,t,n,r){var i,o="",u=document.getElementById(t);if(!u)throw"*** Error: unknown script element"+t;if(o=u.text,!n)if("x-shader/x-vertex"==u.type)i=e.VERTEX_SHADER;else if("x-shader/x-fragment"==u.type)i=e.FRAGMENT_SHADER;else if(i!=e.VERTEX_SHADER&&i!=e.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return console.log("shader source:",o),a(e,o,n?n:i,r)}function f(e,t,n,r,i){for(var o=[],a=0;a<t.length;++a)o.push(l(e,t[a],e[H[a]],i));return u(e,o,n,r,i)}function s(e,t,n,r,i){for(var o=[],l=0;l<t.length;++l)o.push(a(e,t[l],e[H[l]],i));return u(e,o,n,r,i)}function g(e,t,n,r,i){var t=t.map(function(e){var t=document.getElementById(e);return t?t.text:e}),o=s(e,t,n,r,i);if(o){var a=m(e,o),u=d(e,o);return{program:o,uniformSetters:a,attribSetters:u}}}function c(e,t){return t==e.SAMPLER_2D?e.TEXTURE_2D:t==e.SAMPLER_CUBE?e.TEXTURE_CUBE_MAP:void 0}function m(e,t){function n(t,n){var i=e.getUniformLocation(t,n.name),o=n.type,a=n.size>1&&"[0]"==n.name.substr(-3);if(o==e.FLOAT&&a)return function(t){e.uniform1fv(i,t)};if(o==e.FLOAT)return function(t){e.uniform1f(i,t)};if(o==e.FLOAT_VEC2)return function(t){e.uniform2fv(i,t)};if(o==e.FLOAT_VEC3)return function(t){e.uniform3fv(i,t)};if(o==e.FLOAT_VEC4)return function(t){e.uniform4fv(i,t)};if(o==e.INT&&a)return function(t){e.uniform1iv(i,t)};if(o==e.INT)return function(t){e.uniform1i(i,t)};if(o==e.INT_VEC2)return function(t){e.uniform2iv(i,t)};if(o==e.INT_VEC3)return function(t){e.uniform3iv(i,t)};if(o==e.INT_VEC4)return function(t){e.uniform4iv(i,t)};if(o==e.BOOL)return function(t){e.uniform1iv(i,t)};if(o==e.BOOL_VEC2)return function(t){e.uniform2iv(i,t)};if(o==e.BOOL_VEC3)return function(t){e.uniform3iv(i,t)};if(o==e.BOOL_VEC4)return function(t){e.uniform4iv(i,t)};if(o==e.FLOAT_MAT2)return function(t){e.uniformMatrix2fv(i,!1,t)};if(o==e.FLOAT_MAT3)return function(t){e.uniformMatrix3fv(i,!1,t)};if(o==e.FLOAT_MAT4)return function(t){e.uniformMatrix4fv(i,!1,t)};if((o==e.SAMPLER_2D||o==e.SAMPLER_CUBE)&&a){for(var u=[],l=0;l<info.size;++l)u.push(r++);return function(t,n){return function(r){e.uniform1iv(i,n),r.forEach(function(r,i){e.activeTexture(e.TEXTURE0+n[i]),e.bindTexture(t,tetxure)})}}(c(e,o),u)}if(o==e.SAMPLER_2D||o==e.SAMPLER_CUBE)return function(t,n){return function(r){e.uniform1i(i,n),e.activeTexture(e.TEXTURE0+n),e.bindTexture(t,r)}}(c(e,o),r++);throw"unknown type: 0x"+o.toString(16)}for(var r=0,i={},o=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),a=0;o>a;++a){var u=e.getActiveUniform(t,a);if(!u)break;var l=u.name;"[0]"==l.substr(-3)&&(l=l.substr(0,l.length-3));var f=n(t,u);i[l]=f}return i}function h(e,t){Object.keys(t).forEach(function(n){var r=e[n];r&&r(t[n])})}function d(e,t){function n(t){return function(n){e.bindBuffer(e.ARRAY_BUFFER,n.buffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,n.numComponents||n.size,n.type||e.FLOAT,n.normalize||!1,n.stride||0,n.offset||0)}}for(var r={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),o=0;i>o;++o){var a=e.getActiveAttrib(t,o);if(!a)break;var u=e.getAttribLocation(t,a.name);r[a.name]=n(u)}return r}function E(e,t){Object.keys(t).forEach(function(n){var r=e[n];r&&r(t[n])})}function p(e,t,n){E(t,n.attribs),n.indices&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.indices)}function v(e,t){for(var n=0;n<z.length;++n){var r=z[n]+t,i=e.getExtension(r);if(i)return i}}function T(e){var t=e.clientWidth,n=e.clientHeight;return e.width!=t||e.height!=n?(e.width=t,e.height=n,!0):!1}function b(e){if(t(e))for(var n=e.parent.document.getElementsByTagName("iframe"),r=0;r<n.length;++r){var i=n[r];if(i.contentDocument===e.document)return i}}function A(e){var t=b(e);if(!t)return!0;var n=t.getBoundingClientRect(),r=n.top<e.parent.innerHeight&&n.bottom>=0&&n.left<e.parent.innerWidth&&n.right>=0;return r&&A(e.parent)}function y(e){var t=!0;if(e){var n=e.getBoundingClientRect();t=n.top<G.innerHeight&&n.bottom>=0}return t&&A(G)}function _(e,t){var n=0;return e.push=function(){for(var t=0;t<arguments.length;++t){var r=arguments[t];if(r instanceof Array||r.buffer&&r.buffer instanceof ArrayBuffer)for(var i=0;i<r.length;++i)e[n++]=r[i];else e[n++]=r}},e.reset=function(e){n=e||0},e.numComponents=t,Object.defineProperty(e,"numElements",{get:function(){return this.length/this.numComponents|0}}),e}function R(e,t,n){var r=n||Float32Array;return _(new r(e*t),e)}function x(e,t,n,r){n=n||e.ARRAY_BUFFER;var i=e.createBuffer();return e.bindBuffer(n,i),e.bufferData(n,t,r||e.STATIC_DRAW),i}function w(e){return"indices"!==e}function L(e){var t={};return Object.keys(e).filter(w).forEach(function(e){t["a_"+e]=e}),t}function S(e,t){if(t instanceof Int8Array)return e.BYTE;if(t instanceof Uint8Array)return e.UNSIGNED_BYTE;if(t instanceof Int16Array)return e.SHORT;if(t instanceof Uint16Array)return e.UNSIGNED_SHORT;if(t instanceof Int32Array)return e.INT;if(t instanceof Uint32Array)return e.UNSIGNED_INT;if(t instanceof Float32Array)return e.FLOAT;throw"unsupported typed array type"}function U(e){return e instanceof Int8Array?!0:e instanceof Uint8Array?!0:!1}function C(e){return e.buffer&&e.buffer instanceof ArrayBuffer}function F(e,t){var n;if(n=e.indexOf("coord")>=0?2:e.indexOf("color")>=0?4:3,t%n>0)throw"can not guess numComponents. You should specify it.";return n}function I(e,t){if(C(e))return e;Array.isArray(e)&&(e={data:e}),e.numComponents||(e.numComponents=F(t,e.length));var n=e.type;n||"indices"===t&&(n=Uint16Array);var r=R(e.numComponents,e.data.length/e.numComponents|0,n);return r.push(e.data),r}function O(e,t,n){var r=n||L(t),i={};return Object.keys(r).forEach(function(n){var o=r[n],a=I(t[o],o);i[n]={buffer:x(e,a),numComponents:a.numComponents||F(o),type:S(e,a),normalize:U(a)}}),i}function B(e){var t=Object.keys(e)[0],n=e[t];return C(n)?n.numElements:n.data.length/n.numComponents}function P(e,t,n){var r={attribs:O(e,t,n)},i=t.indices;return i?(i=I(i,"indices"),r.indices=x(e,i,e.ELEMENT_ARRAY_BUFFER),r.numElements=i.length):r.numElements=B(t),r}function D(e,t){var n={};return Object.keys(t).forEach(function(r){var i="indices"==r?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER,o=I(t[r],name);n[r]=x(e,o,i)}),t.indices?n.numElements=t.indices.length:t.position&&(n.numElements=t.position.length/3),n}function N(e,t,n,r,i){var o=n.indices,a=void 0===r?n.numElements:r;i=void 0===i?i:0,o?e.drawElements(t,a,e.UNSIGNED_SHORT,i):e.drawArrays(t,i,a)}function M(e){var t=null,n=null;e.forEach(function(e){var r=e.programInfo,i=e.bufferInfo;r!==t&&(t=r,gl.useProgram(r.program)),i!=n&&(n=i,p(gl,r.attribSetters,i)),h(r.uniformSetters,e.uniforms),N(gl,gl.TRIANGLES,i)})}var G=this,k='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',X='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',W=function(e,t){for(var n=["webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=e.getContext(n[i],t)}catch(o){}if(r)break}return r},H=["VERTEX_SHADER","FRAGMENT_SHADER"],z=["","MOZ_","OP_","WEBKIT_"];return G.requestAnimationFrame&&(G.requestAnimationFrame=function(e){return function(t,n){var r=function(){y(n)?e(t,n):e(r,n)};r()}}(G.requestAnimationFrame)),G.requestAnimFrame=G.requestAnimationFrame,G.cancelRequestAnimFrame=G.cancelAnimationFrame,{createAugmentedTypedArray:R,createAttribsFromArrays:O,createBuffersFromArrays:D,createBufferInfoFromArrays:P,createAttributeSetters:d,createProgram:u,createProgramFromScripts:f,createProgramFromSources:s,createProgramInfo:g,createUniformSetters:m,drawBufferInfo:N,drawObjectList:M,getWebGLContext:o,updateCSSIfInIFrame:i,getExtensionWithKnownPrefixes:v,resizeCanvasToDisplaySize:T,setAttributes:E,setBuffersAndAttributes:p,setUniforms:h,setupWebGL:r}}),function(e,t){"object"==typeof exports?module.exports=t(e,e.document):"function"==typeof define&&define.amd?define(function(){return t(e,e.document)}):e.Sketch=t(e,e.document)}(this,function(e,t){"use strict";function n(e){return"[object Array]"==Object.prototype.toString.call(e)}function r(e){return"function"==typeof e}function i(e){return"number"==typeof e}function o(e){return"string"==typeof e}function a(e){return _[e]||String.fromCharCode(e)}function u(e,t,n){for(var r in t)!n&&r in e||(e[r]=t[r]);return e}function l(e,t){return function(){e.apply(t,arguments)}}function f(e){var t={};for(var n in e)t[n]=r(e[n])?l(e[n],e):e[n];return t}function s(e){function t(t){r(t)&&t.apply(e,[].splice.call(arguments,1))}function n(e){for(B=0;B<ee.length;B++)N=ee[B],o(N)?U[(e?"add":"remove")+"EventListener"].call(U,N,S,!1):r(N)?S=N:U=N}function i(){I(L),L=F(i),K||(t(e.setup),K=r(e.setup)),q||(t(e.resize),q=r(e.resize)),e.running&&!V&&(e.dt=(D=+new Date)-e.now,e.millis+=e.dt,e.now=D,t(e.update),Z&&(e.retina&&(e.save(),e.scale(Q,Q)),e.autoclear&&e.clear()),t(e.draw),Z&&e.retina&&e.restore()),V=++V%e.interval}function l(){U=J?e.style:e.canvas,P=J?"px":"",z=e.width||e.element.width,Y=e.height||e.element.height,e.fullscreen&&(Y=e.height=b.innerHeight,z=e.width=b.innerWidth),e.retina&&Z&&Q&&(U.style.height=Y+"px",U.style.width=z+"px",z*=Q,Y*=Q),U.height!==Y&&(U.height=Y+P),U.width!==z&&(U.width=z+P),K&&t(e.resize)}function s(e,t){return O=t.getBoundingClientRect(),e.x=e.pageX-O.left-(b.scrollX||b.pageXOffset),e.y=e.pageY-O.top-(b.scrollY||b.pageYOffset),e.x*=t.width/O.width,e.y*=t.height/O.height,e}function g(t,n){return s(t,e.element),n=n||{},n.ox=n.x||t.x,n.oy=n.y||t.y,n.x=t.x,n.y=t.y,n.dx=n.x-n.ox,n.dy=n.y-n.oy,n}function c(e){if(e.preventDefault(),M=f(e),M.originalEvent=e,M.touches)for(j.length=M.touches.length,B=0;B<M.touches.length;B++)j[B]=g(M.touches[B],j[B]);else j.length=0,j[0]=g(M,$);return u($,j[0],!0),M}function m(n){for(n=c(n),W=(H=ee.indexOf(G=n.type))-1,e.dragging=/down|start/.test(G)?!0:/up|end/.test(G)?!1:e.dragging;W;)o(ee[W])?t(e[ee[W--]],n):o(ee[H])?t(e[ee[H++]],n):W=0}function h(n){k=n.keyCode,X="keyup"==n.type,te[k]=te[a(k)]=!X,t(e[n.type],n)}function d(n){e.autopause&&("blur"==n.type?y:p)(),t(e[n.type],n)}function p(){e.now=+new Date,e.running=!0}function y(){e.running=!1}function R(){(e.running?y:p)()}function x(){Z&&e.clearRect(0,0,e.width,e.height)}function w(){C=e.element.parentNode,B=A.indexOf(e),C&&C.removeChild(e.element),~B&&A.splice(B,1),n(!1),y()}var L,S,U,C,O,B,P,D,N,M,G,k,X,W,H,z,Y,V=0,j=[],q=!1,K=!1,Q=b.devicePixelRatio||1,J=e.type==v,Z=e.type==E,$={x:0,y:0,ox:0,oy:0,dx:0,dy:0},ee=[e.element,m,"mousedown","touchstart",m,"mousemove","touchmove",m,"mouseup","touchend",m,"click",m,"mouseout",m,"mouseover",T,h,"keydown","keyup",b,d,"focus","blur",l,"resize"],te={};for(k in _)te[_[k]]=!1;return u(e,{touches:j,mouse:$,keys:te,dragging:!1,running:!1,millis:0,now:0/0,dt:0/0,destroy:w,toggle:R,clear:x,start:p,stop:y}),A.push(e),e.autostart&&p(),n(!0),l(),i(),e}for(var g,c,m="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),h="__hasSketch",d=Math,E="canvas",p="webgl",v="dom",T=t,b=e,A=[],y={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:T.body,interval:1,globals:!0,retina:!1,type:E},_={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},R={CANVAS:E,WEB_GL:p,WEBGL:p,DOM:v,instances:A,install:function(e){if(!e[h]){for(var t=0;t<m.length;t++)e[m[t]]=d[m[t]];u(e,{TWO_PI:2*d.PI,HALF_PI:d.PI/2,QUATER_PI:d.PI/4,random:function(e,t){return n(e)?e[~~(d.random()*e.length)]:(i(t)||(t=e||1,e=0),e+d.random()*(t-e))},lerp:function(e,t,n){return e+n*(t-e)},map:function(e,t,n,r,i){return(e-t)/(n-t)*(i-r)+r}}),e[h]=!0}},create:function(e){return e=u(e||{},y),e.globals&&R.install(self),g=e.element=e.element||T.createElement(e.type===v?"div":"canvas"),c=e.context=e.context||function(){switch(e.type){case E:return g.getContext("2d",e);case p:return g.getContext("webgl",e)||g.getContext("experimental-webgl",e);case v:return g.canvas=g}}(),e.exists||(e.container||T.body).appendChild(g),R.augment(c,e)},augment:function(e,t){return t=u(t||{},y),t.element=e.canvas||e,t.element.className+=" sketch",u(e,t,!0),s(e)}},x=["ms","moz","webkit","o"],w=self,L=0,S="AnimationFrame",U="request"+S,C="cancel"+S,F=w[U],I=w[C],O=0;O<x.length&&!F;O++)F=w[x[O]+"Request"+S],I=w[x[O]+"Cancel"+S];return w[U]=F=F||function(e){var t=+new Date,n=d.max(0,16-(t-L)),r=setTimeout(function(){e(t+n)},n);return L=t+n,r},w[C]=I=I||function(e){clearTimeout(e)},R});var settings={clear2d:!1,clear3d:!1,togglemap:function(){$("#map").toggle()}},gui=new dat.GUI;gui.add(settings,"clear2d"),gui.add(settings,"clear3d"),gui.add(settings,"togglemap"),L.ImageOverlay.Canvas=L.ImageOverlay.extend({includes:L.Mixin.Events,options:{width:1e3,height:1e3},initialize:function(e,t){this._bounds=L.latLngBounds(e),L.Util.setOptions(this,t)},_initImage:function(){var e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),t=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),n=t._subtract(e);this._image=this.canvas=L.DomUtil.create("canvas","leaflet-image-layer"),this.options.id&&(this._image.id=this.options.id),this._image.width=this.options.width||n.x,this._image.height=this.options.width||n.y,this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this)})},_reset:function(){var e=this._image,t=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),n=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),r=n._subtract(t);e.width=this.options.width||r.x,e.height=this.options.width||r.y,L.DomUtil.setPosition(e,t),e.style.width=r.x+"px",e.style.height=r.y+"px"},_onImageLoad:function(){this.fire("load")}}),L.imageOverlay.canvas=function(e,t){return new L.ImageOverlay.Canvas(e,t)};var map=L.map("map").setView([37.92,-122.07],10);L.tileLayer("https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png",{maxZoom:18,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"examples.map-i875mjb7"}).addTo(map);var southWest=L.latLng(37.405,-122.66),northEast=L.latLng(38.305,-121.885),bounds=L.latLngBounds(southWest,northEast);L.imageOverlay.canvas(bounds,{id:"webgl"}).addTo(map),L.imageOverlay.canvas(bounds,{id:"drawing"}).addTo(map);var COLOURS=["#E3EB64","#A7EBCA","#DD2244","#D8EBA7","#868E80"],radius=0;Sketch.create({element:document.getElementById("drawing"),container:document.getElementById("drawingcontainer"),autoclear:!1,fullscreen:!1,exists:!0,setup:function(){console.log("setup")},update:function(){radius=10},keydown:function(){this.keys.C&&this.clear()},touchmove:function(){if(this.keys.SHIFT)for(var e,t=this.touches.length-1;t>=0;t--)e=this.touches[t],this.lineCap="round",this.lineJoin="round",this.fillStyle=this.strokeStyle=COLOURS[Math.floor(Math.random()*COLOURS.length)],this.lineWidth=radius,this.beginPath(),this.moveTo(e.ox,e.oy),this.lineTo(e.x,e.y),this.stroke(),this.fill()},click:function(){for(var e,t=this.touches.length-1;t>=0;t--)e=this.touches[t],this.lineCap="round",this.lineJoin="round",this.fillStyle=this.strokeStyle=COLOURS[Math.floor(Math.random()*COLOURS.length)],this.lineWidth=radius,this.beginPath(),this.moveTo(e.ox,e.oy),this.arc(e.ox,e.oy,radius,0,2*Math.PI),this.fill();console.log("click",this)}});var webgl=document.getElementById("webgl"),uv=document.getElementById("uv"),drawing=document.getElementById("drawing"),drawingContext=drawing.getContext("2d"),gl=setupWebGL(webgl,{preserveDrawingBuffer:!1,premultipliedAlpha:!0,stencil:!1});gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var textures=[{name:"webgl",clamping:gl.CLAMP_TO_EDGE,interpolation:gl.NEAREST,texture:null,sampler:null,fbo:null,element:webgl,width:webgl.width,height:webgl.height},{name:"drawing",clamping:gl.CLAMP_TO_EDGE,interpolation:gl.NEAREST,texture:null,sampler:null,fbo:null,element:drawing,width:drawing.width,height:drawing.height},{name:"uv",clamping:gl.CLAMP_TO_EDGE,interpolation:gl.LINEAR,texture:null,sampler:null,fbo:null,element:uv,width:uv.width,height:uv.height}];_.each(textures,function(e){$(e.element).on("load",function(){console.log(this,"loaded"),e.width=e.element.width,e.height=e.element.height})});var framebuffers=[{name:"fbo0",clamping:gl.CLAMP_TO_EDGE,interpolation:gl.LINEAR,texture:null,sampler:null,fbo:null,element:webgl,width:webgl.width,height:webgl.height},{name:"fbo1",clamping:gl.CLAMP_TO_EDGE,interpolation:gl.NEAREST,texture:null,sampler:null,fbo:null,element:webgl,width:webgl.width,height:webgl.height}],render,vertex=document.getElementById("vertex"),vertexSource=fetch(vertex.src).then(function(e){return e.text()}).then(function(e){return e}),fragment=document.getElementById("fragment"),fragmentSource=fetch(fragment.src).then(function(e){return e.text()}).then(function(e){return e});Promise.all([vertexSource,fragmentSource]).then(function(e){function t(e){c=1e3/e,d=Date.now(),m=d,console.log(m),render()}var n=createProgramFromSources(gl,e);gl.useProgram(n);var r=gl.getAttribLocation(n,"a_position"),i=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,i),gl.enableVertexAttribArray(r),gl.vertexAttribPointer(r,2,gl.FLOAT,!1,0,0);var o=-1,a=1,u=-1,l=1;gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([o,u,a,u,a,l,o,l]),gl.STATIC_DRAW);var f=gl.getUniformLocation(n,"u_webglSize");gl.uniform2f(f,webgl.width,webgl.height);var s=gl.getUniformLocation(n,"u_flipY");gl.uniform1f(s,1),console.log("webglsize",f,"flip",s),_.each(textures,function(e,t){var r=gl.createTexture();e.id=gl.TEXTURE0+t,gl.activeTexture(e.id),gl.bindTexture(gl.TEXTURE_2D,r),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,e.clamping),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,e.clamping),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,e.interpolation),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,e.interpolation),e.texture=r,console.log(r.element),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.element);var i=gl.getUniformLocation(n,"u_image"+e.name);gl.uniform1i(i,t),e.sampler=i}),console.log(textures),_.each(framebuffers,function(e,t){var r=gl.createTexture();e.id=gl.TEXTURE0+t+textures.length,gl.activeTexture(e.id),gl.bindTexture(gl.TEXTURE_2D,r),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,e.clamping),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,e.clamping),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,e.interpolation),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,e.interpolation),e.texture=r,gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,webgl.width,webgl.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);var i=gl.getUniformLocation(n,"u_image"+e.name);gl.uniform1i(i,t+textures.length),e.sampler=i,e.fbo=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,e.texture,0)});var g=_.filter(_.map(settings,function(e,t){return{name:t,value:e,gl:"number"==typeof e||"boolean"==typeof e,type:typeof e}}),function(e){return e.gl});_.each(g,function(e){console.log(e),e.location=gl.getUniformLocation(n,"u_"+e.name),gl.uniform1f(e.location,e.value)}),console.log(g),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.clearColor(1,1,1,.2),gl.clear(gl.COLOR_BUFFER_BIT);var c,m,h,d,E,p=!1,v=0;render=function(){if(!p&&(requestAnimationFrame(render),h=Date.now(),E=h-d,E>c)){_.each(g,function(e){e.value!==settings[e.name]&&(e.value=settings[e.name],"boolean"===e.type&&(console.log("updating setting",e),gl.uniform1i(e.location,e.value)))}),d=h-E%c,gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.activeTexture(textures[1].id),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,textures[1].element),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.uniform1f(s,-1),gl.drawArrays(gl.TRIANGLE_STRIP,0,4);var e=framebuffers[0],t=framebuffers[1];gl.bindFramebuffer(gl.FRAMEBUFFER,t.fbo),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.uniform1f(s,1),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),gl.activeTexture(e.id),gl.copyTexImage2D(gl.TEXTURE_2D,0,gl.RGBA,0,0,webgl.width,webgl.height,0),settings.clear2d&&drawingContext.clearRect(0,0,drawing.width,drawing.height);var n=h-m,r=Math.round(1e3/(n/++v)*100)/100;v%100===0&&console.log("Elapsed time:",Math.round(n/1e3*100)/100,"fps",r,"frameCount:",v)}},t(60)});